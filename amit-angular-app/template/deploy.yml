deploy:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - apk add --no-cache python3 py3-pip
    - pip3 install awscli
    - export PATH=$PATH:/root/.local/bin
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_IMAGE: amit-angular-gitlab-app:latest
    ECR_REGISTRY: <your-aws-account-id>.dkr.ecr.<your-region>.amazonaws.com
    ECR_REPOSITORY: amit-angular-gitlab-app
  script:
    - $(aws ecr get-login --no-include-email --region <your-region>)
    - docker tag $DOCKER_IMAGE $ECR_REGISTRY/$ECR_REPOSITORY:$CI_COMMIT_SHA
    - docker push $ECR_REGISTRY/$ECR_REPOSITORY:$CI_COMMIT_SHA
    - docker tag $DOCKER_IMAGE $ECR_REGISTRY/$ECR_REPOSITORY:latest
    - docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest